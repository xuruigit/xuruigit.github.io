<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.1" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=6.4.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.1">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.1" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.4.1',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="背景 目前在做的项目使用 dubbo 作为分布式服务框架，新项目开发过程中遇到一个问题：provider 端抛出了自定义的业务异常，而 consumer 接收到的却是 RpcException，原来的业务异常（包括异常栈）被包装到了 message 中，导致 consumer 不能正确获取 provider 想要提供的 message。">
<meta name="keywords" content="Spring,Dubbo">
<meta property="og:type" content="article">
<meta property="og:title" content="基于dubbo的分布式应用中的统一异常处理">
<meta property="og:url" content="http://xurui.pro/2018/05/29/基于dubbo的分布式应用中的统一异常处理/index.html">
<meta property="og:site_name" content="徐锐">
<meta property="og:description" content="背景 目前在做的项目使用 dubbo 作为分布式服务框架，新项目开发过程中遇到一个问题：provider 端抛出了自定义的业务异常，而 consumer 接收到的却是 RpcException，原来的业务异常（包括异常栈）被包装到了 message 中，导致 consumer 不能正确获取 provider 想要提供的 message。">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-09-17T05:16:24.036Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于dubbo的分布式应用中的统一异常处理">
<meta name="twitter:description" content="背景 目前在做的项目使用 dubbo 作为分布式服务框架，新项目开发过程中遇到一个问题：provider 端抛出了自定义的业务异常，而 consumer 接收到的却是 RpcException，原来的业务异常（包括异常栈）被包装到了 message 中，导致 consumer 不能正确获取 provider 想要提供的 message。">






  <link rel="canonical" href="http://xurui.pro/2018/05/29/基于dubbo的分布式应用中的统一异常处理/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>基于dubbo的分布式应用中的统一异常处理 | 徐锐</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">徐锐</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://xurui.pro/2018/05/29/基于dubbo的分布式应用中的统一异常处理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="徐锐">
      <meta itemprop="description" content="基于Hexo搭建的个人博客">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="徐锐">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">基于dubbo的分布式应用中的统一异常处理
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-05-29 13:51:56" itemprop="dateCreated datePublished" datetime="2018-05-29T13:51:56+08:00">2018-05-29</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-17 13:16:24" itemprop="dateModified" datetime="2018-09-17T13:16:24+08:00">2018-09-17</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><blockquote>
<p>目前在做的项目使用 <code>dubbo</code> 作为分布式服务框架，新项目开发过程中遇到一个问题：<code>provider</code> 端抛出了自定义的业务异常，而 <code>consumer</code> 接收到的却是 <code>RpcException</code>，原来的业务异常（包括异常栈）被包装到了 <code>message</code> 中，导致 <code>consumer</code> 不能正确获取 <code>provider</code> 想要提供的 <code>message</code>。  </p>
</blockquote>
<a id="more"></a>
<p>出现这个问题，有几个前提： </p>
<ul>
<li>自定义的异常</li>
<li>自定义的业务异常继承 <code>RuntimeException</code>，属于运行期/非检查异常</li>
<li>自定义的业务异常在二方包/三方包中，不在 <code>provider</code> 提供的API包中</li>
</ul>
<h2 id="先说结论"><a href="#先说结论" class="headerlink" title="先说结论"></a>先说结论</h2><p>基于上面的几个前提，可以发现<strong>自定义的异常可能会在 <code>consumer</code> 接收时反序列化失败</strong>，因为这个异常不一定在 <code>consumer</code>中存在。而dubbo为了避免这种情况出现，使用 <code>ExceptionFilter</code> 过滤器对异常进行了包装，转换为 <code>RuntimeException</code> 提供给 <code>consumer</code> 。  </p>
<p>最后我利用 <code>Spring AOP</code> 拦截掉<code>provider</code>所有异常，将异常包装成<code>Response</code>(一个自定义的返回值对象POJO)返回给<code>consumer</code>，规避掉了 <code>dubbo</code> 的处理。</p>
<h2 id="ExceptionFilter-dubbo-的异常处理源码"><a href="#ExceptionFilter-dubbo-的异常处理源码" class="headerlink" title="ExceptionFilter - dubbo 的异常处理源码"></a>ExceptionFilter - dubbo 的异常处理源码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Activate</span>(group = Constants.PROVIDER)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Logger logger;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExceptionFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(LoggerFactory.getLogger(ExceptionFilter.class));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ExceptionFilter</span><span class="params">(Logger logger)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = logger;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">invoke</span><span class="params">(Invoker&lt;?&gt; invoker, Invocation invocation)</span> <span class="keyword">throws</span> RpcException </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Result result = invoker.invoke(invocation);</span><br><span class="line">            <span class="keyword">if</span> (result.hasException() &amp;&amp; GenericService.class != invoker.getInterface()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Throwable exception = result.getException();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 检查异常，直接抛出</span></span><br><span class="line">                    <span class="keyword">if</span> (!(exception <span class="keyword">instanceof</span> RuntimeException) &amp;&amp; (exception <span class="keyword">instanceof</span> Exception)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 方法签名上有说明抛出非检查异常，直接抛出</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Method method = invoker.getInterface().getMethod(invocation.getMethodName(), invocation.getParameterTypes());</span><br><span class="line">                        Class&lt;?&gt;[] exceptionClassses = method.getExceptionTypes();</span><br><span class="line">                        <span class="keyword">for</span> (Class&lt;?&gt; exceptionClass : exceptionClassses) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (exception.getClass().equals(exceptionClass)) &#123;</span><br><span class="line">                                <span class="keyword">return</span> result;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// for the exception not found in method's signature, print ERROR message in server's log.</span></span><br><span class="line">                    logger.error(<span class="string">"Got unchecked and undeclared exception which called by "</span> + RpcContext.getContext().getRemoteHost()</span><br><span class="line">                            + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br><span class="line">                            + <span class="string">", exception: "</span> + exception.getClass().getName() + <span class="string">": "</span> + exception.getMessage(), exception);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 异常类和接口类在同一jar包里，直接抛出</span></span><br><span class="line">                    String serviceFile = ReflectUtils.getCodeBase(invoker.getInterface());</span><br><span class="line">                    String exceptionFile = ReflectUtils.getCodeBase(exception.getClass());</span><br><span class="line">                    <span class="keyword">if</span> (serviceFile == <span class="keyword">null</span> || exceptionFile == <span class="keyword">null</span> || serviceFile.equals(exceptionFile)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// JDK异常，直接抛出</span></span><br><span class="line">                    String className = exception.getClass().getName();</span><br><span class="line">                    <span class="keyword">if</span> (className.startsWith(<span class="string">"java."</span>) || className.startsWith(<span class="string">"javax."</span>)) &#123;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// dubbo异常，直接抛出</span></span><br><span class="line">                    <span class="keyword">if</span> (exception <span class="keyword">instanceof</span> RpcException) &#123;</span><br><span class="line">                        <span class="keyword">return</span> result;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 否则，包装成RuntimeException抛给客户端</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> RpcResult(<span class="keyword">new</span> RuntimeException(StringUtils.toString(exception)));</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    logger.warn(<span class="string">"Fail to ExceptionFilter when called by "</span> + RpcContext.getContext().getRemoteHost()</span><br><span class="line">                            + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br><span class="line">                            + <span class="string">", exception: "</span> + e.getClass().getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">                    <span class="keyword">return</span> result;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">            logger.error(<span class="string">"Got unchecked and undeclared exception which called by "</span> + RpcContext.getContext().getRemoteHost()</span><br><span class="line">                    + <span class="string">". service: "</span> + invoker.getInterface().getName() + <span class="string">", method: "</span> + invocation.getMethodName()</span><br><span class="line">                    + <span class="string">", exception: "</span> + e.getClass().getName() + <span class="string">": "</span> + e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重点的话，就在：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// 否则，包装成RuntimeException抛给客户端</span><br><span class="line">return new RpcResult(new RuntimeException(StringUtils.toString(exception)));</span><br></pre></td></tr></table></figure>
<p>为了避免反序列化失败，dubbo这样处理也是合理的，但确实和目前项目的应用情况有冲突，要如何解决这个问题？  </p>
<h3 id="常规来说有如下方法："><a href="#常规来说有如下方法：" class="headerlink" title="常规来说有如下方法："></a>常规来说有如下方法：</h3><ol>
<li><p>将该异常的包名以<code>java.</code>或者<code>javax.</code> 开头<br> 不符合规范，排除</p>
</li>
<li><p>异常继承Exception<br> 自定义的业务异常本身属于 <code>RuntimeException</code>, 排除</p>
</li>
<li><p>异常类和接口类在同一jar包里<br> 较大的项目一般都会有一些common包，定义好异常类型，使用二方包的方式引用，所以也不适用，排除</p>
</li>
<li><p><code>provider</code>的<code>api</code>明确写明<code>throws XxxException</code><br> 作为服务端，不应显式抛出异常给客户的进行处理，排除</p>
</li>
<li><p>实现 <code>dubbo</code> 的 <code>filter</code>，自定 <code>provider</code> 的异常处理逻辑<br> 可以在原有逻辑基础上增加: </p>
 <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="string">"自定义异常的包路径"</span>.equals(exceptionFile))&#123;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p> 可行，但是逻辑中写死了异常的路径，而且也不能保证后期其他 <code>consumer</code>，会引用这个二方包。</p>
</li>
</ol>
<h2 id="最终方案"><a href="#最终方案" class="headerlink" title="最终方案"></a>最终方案</h2><p>结合项目的实际情况，我们项目中 <code>provider</code> 提供的接口返回值全部包装一层再提供出去，这样的好处是服务和服务之间的交互使用的数据对象都是一样的，便于使用，这个对象比较常规：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> success;</span><br><span class="line">    <span class="keyword">private</span> T result;</span><br><span class="line">    <span class="keyword">private</span> String error;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我觉得Response中增加 <code>private String code;</code> 用于标记错误类型，会更好一些<br>基于这个前提，我想利用 <code>Spring AOP</code> 拦截掉<code>provider</code>所有异常，将异常包装成<code>Response</code>对外提供，规避掉 <code>dubbo</code> 的处理。如果是业务异常利用 <code>error</code> 提供简单异常信息给外部，如果非业务异常只提示<code>服务调用失败</code>，具体错误输出到日志，再通过<code>kibana</code>等日志平台查看。  </p>
<p>代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务层异常处理器</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by XuRui on 2018/5/28.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceExceptionHandle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 指定返回值为Response类型的Service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(public com.xurui.youth.dto.Response com.xurui.youth.service..*Service*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">servicePointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// Do nothing just pointcut</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理切面</span></span><br><span class="line"><span class="comment">     * 将异常包装为Response，避免dubbo进行包装</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp 处理点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回异常处理结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"servicePointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doAround</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">        Object[] args = pjp.getArgs();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">            <span class="comment">// 业务自定义异常</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException | JsonResponseException | ServiceResponseException e) &#123;</span><br><span class="line">            processException(pjp, args, e);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            processException(pjp, args, e);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(<span class="string">"服务调用失败"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            processException(pjp, args, throwable);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(<span class="string">"系统异常"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args      参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processException</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint joinPoint, <span class="keyword">final</span> Object[] args, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        String inputParam = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">                sb.append(<span class="string">","</span>);</span><br><span class="line">                sb.append(arg);</span><br><span class="line">            &#125;</span><br><span class="line">            inputParam = sb.toString().substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.warn(<span class="string">"\n 方法: &#123;&#125;\n 入参: &#123;&#125; \n 错误信息: &#123;&#125;"</span>, joinPoint.toLongString(), inputParam, Throwables.getStackTraceAsString(throwable));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是这个方式因为拦截掉了service的异常，所以如果多个service存在事务传递的情况，会导致事务失效，因为我们这个项目要求事务单独抽出一层manage来做，所以没有问题。</p>
<p>但是也可以优化：新定义一个切点，声明任何持有@Transactional注解的方法，将这部分需要事务的方法单独处理，最终代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 服务层异常处理器</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * Created by XuRui on 2018/5/28.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceExceptionHandle</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回值类型为Response的Service</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"execution(public com.xurui.youth.dto.Response com.xurui.youth.service..*Service*.*(..))"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">servicePointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任何持有<span class="doctag">@Transactional</span>注解的方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Pointcut</span>(value = <span class="string">"@annotation(org.springframework.transaction.annotation.Transactional)"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">transactionalPointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 异常处理切面</span></span><br><span class="line"><span class="comment">     * 将异常包装为Response，避免dubbo进行包装</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp 处理点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"servicePointcut() &amp;&amp; !transactionalPointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doAround</span><span class="params">(ProceedingJoinPoint pjp)</span> </span>&#123;</span><br><span class="line">        Object[] args = pjp.getArgs();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException | JsonResponseException | ServiceResponseException e) &#123; <span class="comment">// 业务自定义异常</span></span><br><span class="line">            processException(pjp, args, e);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(e.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            processException(pjp, args, e);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(<span class="string">"服务调用失败"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">            processException(pjp, args, throwable);</span><br><span class="line">            <span class="keyword">return</span> Response.fail(<span class="string">"系统异常"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 任何持有<span class="doctag">@Transactional</span>注解的方法异常处理切面</span></span><br><span class="line"><span class="comment">     * 将自定义的业务异常转为RuntimeException:</span></span><br><span class="line"><span class="comment">     * 1.规避dubbo的包装，让customer可以正常获取message</span></span><br><span class="line"><span class="comment">     * 2.抛出RuntimeException使事务可以正确回滚</span></span><br><span class="line"><span class="comment">     * 其他异常不处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pjp 处理点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Around</span>(<span class="string">"servicePointcut() &amp;&amp; transactionalPointcut()"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">doTransactionalAround</span><span class="params">(ProceedingJoinPoint pjp)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> pjp.proceed();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ServiceException | JsonResponseException | ServiceResponseException e) &#123;</span><br><span class="line">            <span class="comment">// dubbo会将异常捕获进行打印，这里就不打印了</span></span><br><span class="line">            <span class="comment">// processException(pjp, args, e);</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理异常</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> joinPoint 切点</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args      参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> throwable 异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processException</span><span class="params">(<span class="keyword">final</span> ProceedingJoinPoint joinPoint, <span class="keyword">final</span> Object[] args, Throwable throwable)</span> </span>&#123;</span><br><span class="line">        String inputParam = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">if</span> (args != <span class="keyword">null</span> &amp;&amp; args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            <span class="keyword">for</span> (Object arg : args) &#123;</span><br><span class="line">                sb.append(<span class="string">","</span>);</span><br><span class="line">                sb.append(arg);</span><br><span class="line">            &#125;</span><br><span class="line">            inputParam = sb.toString().substring(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        log.warn(<span class="string">"\n 方法: &#123;&#125;\n 入参: &#123;&#125; \n 错误信息: &#123;&#125;"</span>, joinPoint.toLongString(), inputParam, Throwables.getStackTraceAsString(throwable));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring/" rel="tag"># Spring</a>
          
            <a href="/tags/Dubbo/" rel="tag"># Dubbo</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/04/28/Spring Cloud 一 分布式配置中心 Spring Cloud Config/" rel="next" title="Spring Cloud (一) 分布式配置中心 Spring Cloud Config">
                <i class="fa fa-chevron-left"></i> Spring Cloud (一) 分布式配置中心 Spring Cloud Config
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/26/YourKit-Java性能分析工具的应用/" rel="prev" title="YourKit-Java性能分析工具的应用">
                YourKit-Java性能分析工具的应用 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">徐锐</p>
              <p class="site-description motion-element" itemprop="description">基于Hexo搭建的个人博客</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">标签</span>
                  
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#先说结论"><span class="nav-number">2.</span> <span class="nav-text">先说结论</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ExceptionFilter-dubbo-的异常处理源码"><span class="nav-number">3.</span> <span class="nav-text">ExceptionFilter - dubbo 的异常处理源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#常规来说有如下方法："><span class="nav-number">3.1.</span> <span class="nav-text">常规来说有如下方法：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#最终方案"><span class="nav-number">4.</span> <span class="nav-text">最终方案</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">徐锐</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动 v3.4.4</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Mist</a> v6.4.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.1"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
